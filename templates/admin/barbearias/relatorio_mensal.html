{% extends "admin/base_site.html" %}
{% load admin_urls static admin_list %}

{% block title %}{{ title }} | {{ site_title|default:"Django site admin" }}{% endblock %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.stat-card {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 15px;
    text-align: center;
}

.stat-number {
    font-size: 2em;
    font-weight: bold;
    color: #417690;
}

.stat-label {
    color: #666;
    margin-top: 5px;
}

.chart-container {
    position: relative;
    height: 300px;
    margin: 20px 0;
}

.export-buttons {
    margin: 20px 0;
}

.export-buttons a {
    display: inline-block;
    background: #417690;
    color: white;
    padding: 10px 20px;
    text-decoration: none;
    border-radius: 4px;
    margin-right: 10px;
}

.export-buttons a:hover {
    background: #205067;
}

.filter-form {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
}

.filter-form select {
    margin: 0 10px;
    padding: 5px;
}
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">Home</a>
&rsaquo; <a href="{% url 'admin:barbearias_barbearia_changelist' %}">Estabelecimentos</a>
&rsaquo; <a href="{% url 'admin:barbearias_barbearia_relatorios' %}">Relat√≥rios</a>
&rsaquo; {{ barbearia.nome }}
</div>
{% endblock %}

{% block content %}
<h1>{{ title }}</h1>
<h2>Per√≠odo: {{ data_inicio|date:"d/m/Y" }} a {{ data_fim|date:"d/m/Y" }}</h2>

<!-- Filtros -->
<div class="filter-form">
    <form method="get">
        <label>Selecionar per√≠odo:</label>
        <select name="mes">
            {% for num, nome in meses %}
            <option value="{{ num }}" {% if num == mes %}selected{% endif %}>{{ nome }}</option>
            {% endfor %}
        </select>
        <select name="ano">
            {% for ano_option in anos %}
            <option value="{{ ano_option }}" {% if ano_option == ano %}selected{% endif %}>{{ ano_option }}</option>
            {% endfor %}
        </select>
        <input type="submit" value="Filtrar" class="default">
    </form>
</div>

<!-- Bot√µes de exporta√ß√£o -->
<div class="export-buttons">
    <a href="{% url 'admin:barbearias_barbearia_relatorio_csv' barbearia.id %}?ano={{ ano }}&mes={{ mes }}">
        üìä Exportar CSV
    </a>
    <a href="javascript:window.print()">
        üñ®Ô∏è Imprimir Relat√≥rio
    </a>
</div>

<!-- Cards de estat√≠sticas -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number">{{ total_agendamentos }}</div>
        <div class="stat-label">Total de Agendamentos</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ agendamentos_concluidos }}</div>
        <div class="stat-label">Agendamentos Conclu√≠dos</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ agendamentos_cancelados }}</div>
        <div class="stat-label">Agendamentos Cancelados</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">R$ {{ faturamento_total|floatformat:2 }}</div>
        <div class="stat-label">Faturamento Total</div>
    </div>
</div>

<!-- Gr√°fico de agendamentos por dia -->
<div class="module">
    <h2>Agendamentos por Dia do M√™s</h2>
    <div class="chart-container">
        <canvas id="agendamentosPorDiaChart"></canvas>
    </div>
</div>

<!-- Gr√°fico de status -->
<div class="module">
    <h2>Distribui√ß√£o por Status</h2>
    <div class="chart-container">
        <canvas id="statusChart"></canvas>
    </div>
</div>

<!-- Tabelas de rankings -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
    <div class="module">
        <h2>Servi√ßos Mais Populares</h2>
        <table>
            <thead>
                <tr>
                    <th>Servi√ßo</th>
                    <th>Quantidade</th>
                </tr>
            </thead>
            <tbody>
                {% for servico in servicos_populares %}
                <tr>
                    <td>{{ servico.servico__nome }}</td>
                    <td>{{ servico.quantidade }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="2">Nenhum servi√ßo encontrado</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="module">
        <h2>Profissionais Mais Procurados</h2>
        <table>
            <thead>
                <tr>
                    <th>Profissional</th>
                    <th>Quantidade</th>
                </tr>
            </thead>
            <tbody>
                {% for profissional in profissionais_populares %}
                <tr>
                    <td>{{ profissional.profissional__nome }}</td>
                    <td>{{ profissional.quantidade }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="2">Nenhum profissional encontrado</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
// Gr√°fico de agendamentos por dia
const ctxDia = document.getElementById('agendamentosPorDiaChart').getContext('2d');
const agendamentosPorDiaChart = new Chart(ctxDia, {
    type: 'line',
    data: {
        labels: [{% for item in agendamentos_por_dia %}'{{ item.dia }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: 'Agendamentos',
            data: [{% for item in agendamentos_por_dia %}{{ item.quantidade }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#417690',
            backgroundColor: 'rgba(65, 118, 144, 0.1)',
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Gr√°fico de status
const ctxStatus = document.getElementById('statusChart').getContext('2d');
const statusChart = new Chart(ctxStatus, {
    type: 'doughnut',
    data: {
        labels: [{% for item in agendamentos_por_status %}'{{ item.status|capfirst }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            data: [{% for item in agendamentos_por_status %}{{ item.quantidade }}{% if not forloop.last %},{% endif %}{% endfor %}],
            backgroundColor: [
                '#417690',
                '#28a745',
                '#dc3545',
                '#ffc107'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false
    }
});
</script>

{% endblock %}
